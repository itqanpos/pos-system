<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ§Ø¬Ø± - POS Pro</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<style>
:root {
  --primary: #2563eb;
  --primary-dark: #1e40af;
  --secondary: #10b981;
  --danger: #dc2626;
  --warning: #f59e0b;
  --bg: #f8fafc;
  --card: #ffffff;
  --text: #0f172a;
  --muted: #64748b;
  --border: #e2e8f0;
  --radius: 12px;
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', 'Tahoma', 'Arial', sans-serif;
  background: var(--bg);
  color: var(--text);
  line-height: 1.6;
}

/* Header */
header {
  background: linear-gradient(135deg, var(--primary), var(--primary-dark));
  color: white;
  padding: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.logo {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 1.5rem;
  font-weight: bold;
}

.user-info {
  display: flex;
  align-items: center;
  gap: 15px;
}

/* Navigation */
nav {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 5px;
  padding: 10px;
  background: white;
  border-bottom: 1px solid var(--border);
}

nav button {
  padding: 12px 8px;
  border: none;
  background: none;
  color: var(--muted);
  cursor: pointer;
  font-size: 14px;
  border-radius: 8px;
  transition: all 0.3s;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
}

nav button:hover {
  background: #f1f5f9;
}

nav button.active {
  background: var(--primary);
  color: white;
}

/* Main Content */
.main-content {
  padding: 20px;
  max-width: 1400px;
  margin: 0 auto;
}

/* Dashboard */
.dashboard-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: white;
  padding: 20px;
  border-radius: var(--radius);
  box-shadow: 0 4px 6px rgba(0,0,0,0.05);
  text-align: center;
}

.stat-card h3 {
  color: var(--muted);
  font-size: 14px;
  margin-bottom: 10px;
}

.stat-card .value {
  font-size: 28px;
  font-weight: bold;
  color: var(--primary);
}

/* Forms */
.form-container {
  background: white;
  border-radius: var(--radius);
  padding: 25px;
  box-shadow: 0 4px 6px rgba(0,0,0,0.05);
  margin-bottom: 20px;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.form-group {
  margin-bottom: 15px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: var(--muted);
  font-weight: 500;
}

.form-control {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 14px;
  transition: border-color 0.3s;
}

.form-control:focus {
  outline: none;
  border-color: var(--primary);
}

/* Tables */
.table-container {
  background: white;
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}

table {
  width: 100%;
  border-collapse: collapse;
}

thead {
  background: #f8fafc;
}

th {
  padding: 15px;
  text-align: right;
  color: var(--muted);
  font-weight: 600;
  border-bottom: 1px solid var(--border);
}

td {
  padding: 15px;
  border-bottom: 1px solid var(--border);
}

tr:hover {
  background: #f8fafc;
}

/* Buttons */
.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
}

.btn-success {
  background: var(--secondary);
  color: white;
}

.btn-danger {
  background: var(--danger);
  color: white;
}

.btn-warning {
  background: var(--warning);
  color: white;
}

.btn-outline {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text);
}

/* Modals */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  align-items: center;
  justify-content: center;
}

.modal.active {
  display: flex;
}

.modal-content {
  background: white;
  border-radius: var(--radius);
  width: 90%;
  max-width: 500px;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  padding: 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-body {
  padding: 20px;
}

/* Responsive */
@media (max-width: 768px) {
  nav {
    grid-template-columns: repeat(3, 1fr);
  }
  
  .dashboard-grid {
    grid-template-columns: 1fr;
  }
  
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  table {
    display: block;
    overflow-x: auto;
  }
}

/* Print Styles */
@media print {
  nav, header button, .no-print {
    display: none !important;
  }
  
  body {
    background: white;
  }
  
  .modal {
    position: static;
    background: none;
  }
  
  .modal-content {
    box-shadow: none;
    max-width: none;
  }
}

/* Utility Classes */
.hidden {
  display: none;
}

.text-center {
  text-align: center;
}

.mb-20 {
  margin-bottom: 20px;
}

.mt-20 {
  margin-top: 20px;
}

.p-20 {
  padding: 20px;
}

.alert {
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 15px;
}

.alert-success {
  background: #d1fae5;
  color: #065f46;
}

.alert-danger {
  background: #fee2e2;
  color: #991b1b;
}

.alert-warning {
  background: #fef3c7;
  color: #92400e;
}

.badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
}

.badge-success {
  background: #d1fae5;
  color: #065f46;
}

.badge-danger {
  background: #fee2e2;
  color: #991b1b;
}

.badge-warning {
  background: #fef3c7;
  color: #92400e;
}
</style>
</head>
<body>

<!-- Header -->
<header>
  <div class="logo">
    <span>ğŸ“Š</span>
    <span>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªØ§Ø¬Ø±</span>
  </div>
  <div class="user-info">
    <span id="currentUser"></span>
    <span id="currentBranch"></span>
    <button class="btn btn-outline" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </div>
</header>

<!-- Navigation -->
<nav>
  <button class="active" data-section="dashboard">
    <span>ğŸ“ˆ</span>
    <span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span>
  </button>
  <button data-section="pos">
    <span>ğŸ’°</span>
    <span>Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹</span>
  </button>
  <button data-section="purchases">
    <span>ğŸ›’</span>
    <span>Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</span>
  </button>
  <button data-section="customers">
    <span>ğŸ‘¥</span>
    <span>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</span>
  </button>
  <button data-section="suppliers">
    <span>ğŸ¢</span>
    <span>Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</span>
  </button>
  <button data-section="products">
    <span>ğŸ“¦</span>
    <span>Ø§Ù„Ø£ØµÙ†Ø§Ù</span>
  </button>
  <button data-section="inventory">
    <span>ğŸ“Š</span>
    <span>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
  </button>
  <button data-section="returns">
    <span>ğŸ”„</span>
    <span>Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø§Øª</span>
  </button>
  <button data-section="expenses">
    <span>ğŸ’¸</span>
    <span>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span>
  </button>
  <button data-section="transactions">
    <span>ğŸ§¾</span>
    <span>ÙƒØ´Ù Ø§Ù„Ø­Ø³Ø§Ø¨</span>
  </button>
  <button data-section="invoices">
    <span>ğŸ“„</span>
    <span>Ø§Ù„ÙÙˆØ§ØªÙŠØ±</span>
  </button>
  <button data-section="notifications">
    <span>ğŸ””</span>
    <span>Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</span>
    <span class="badge badge-danger" id="notificationCount">0</span>
  </button>
  <button data-section="branches">
    <span>ğŸª</span>
    <span>Ø§Ù„ÙØ±ÙˆØ¹</span>
  </button>
  <button data-section="cashbox">
    <span>ğŸ’¼</span>
    <span>Ø§Ù„Ø®Ø²Ù†Ø©</span>
  </button>
  <button data-section="reports">
    <span>ğŸ“‹</span>
    <span>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</span>
  </button>
  <button data-section="settings">
    <span>âš™ï¸</span>
    <span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
  </button>
</nav>

<!-- Main Content -->
<main class="main-content" id="mainContent">
  <!-- Dashboard will be loaded here -->
</main>

<!-- Auth Modal -->
<div class="modal" id="authModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h3>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input type="email" id="loginEmail" class="form-control" placeholder="example@domain.com">
      </div>
      <div class="form-group">
        <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
        <input type="password" id="loginPassword" class="form-control" placeholder="********">
      </div>
      <div class="form-group">
        <label>Ø§Ù„ÙØ±Ø¹</label>
        <select id="loginBranch" class="form-control"></select>
      </div>
      <div class="alert hidden" id="authAlert"></div>
      <button class="btn btn-primary w-100" onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <p class="text-center mt-20">
        Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ 
        <a href="#" onclick="showRegister()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</a>
      </p>
    </div>
  </div>
</div>

<script>
// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyBZwWxWIIE0exAPoL9P8pbmp19gnBFxQq0",
  authDomain: "pos-pro-996f0.firebaseapp.com",
  projectId: "pos-pro-996f0",
  storageBucket: "pos-pro-996f0.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

// Enable offline persistence
db.enablePersistence().catch((err) => {
  console.log("Persistence failed: ", err);
});

// Global Variables
let currentUser = null;
let currentBranch = null;
let currentCashbox = null;
let products = [];
let customers = [];
let suppliers = [];
let cart = [];

// Authentication State Listener
auth.onAuthStateChanged(async (user) => {
  if (user) {
    currentUser = user;
    await loadUserProfile();
    document.getElementById('authModal').classList.remove('active');
    loadSection('dashboard');
  } else {
    document.getElementById('authModal').classList.add('active');
  }
});

// Login Function
async function login() {
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  const branchId = document.getElementById('loginBranch').value;
  
  try {
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    currentUser = userCredential.user;
    currentBranch = branchId;
    
    // Update user branch
    await db.collection('users').doc(currentUser.uid).update({
      currentBranch: branchId,
      lastLogin: new Date()
    });
    
    document.getElementById('authModal').classList.remove('active');
    loadSection('dashboard');
  } catch (error) {
    showAlert('authAlert', error.message, 'danger');
  }
}

// Load User Profile
async function loadUserProfile() {
  const userDoc = await db.collection('users').doc(currentUser.uid).get();
  if (userDoc.exists) {
    const userData = userDoc.data();
    currentBranch = userData.currentBranch;
    
    // Update UI
    document.getElementById('currentUser').textContent = userData.name || userData.email;
    
    // Load branch info
    if (currentBranch) {
      const branchDoc = await db.collection('branches').doc(currentBranch).get();
      if (branchDoc.exists) {
        document.getElementById('currentBranch').textContent = branchDoc.data().name;
      }
    }
    
    // Load notifications
    loadNotifications();
  }
}

// Navigation
document.querySelectorAll('nav button').forEach(button => {
  button.addEventListener('click', function() {
    // Update active state
    document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
    this.classList.add('active');
    
    // Load section
    const section = this.getAttribute('data-section');
    loadSection(section);
  });
});

// Load Section Content
async function loadSection(section) {
  const mainContent = document.getElementById('mainContent');
  
  switch(section) {
    case 'dashboard':
      await loadDashboard();
      break;
    case 'pos':
      await loadPOS();
      break;
    case 'products':
      await loadProducts();
      break;
    case 'customers':
      await loadCustomers();
      break;
    case 'suppliers':
      await loadSuppliers();
      break;
    case 'purchases':
      await loadPurchases();
      break;
    case 'inventory':
      await loadInventory();
      break;
    case 'returns':
      await loadReturns();
      break;
    case 'expenses':
      await loadExpenses();
      break;
    case 'transactions':
      await loadTransactions();
      break;
    case 'invoices':
      await loadInvoices();
      break;
    case 'notifications':
      await loadNotificationsPage();
      break;
    case 'branches':
      await loadBranches();
      break;
    case 'cashbox':
      await loadCashbox();
      break;
    case 'reports':
      await loadReports();
      break;
    case 'settings':
      await loadSettings();
      break;
  }
}

// Dashboard
async function loadDashboard() {
  const today = new Date();
  const startOfDay = new Date(today.setHours(0, 0, 0, 0));
  const endOfDay = new Date(today.setHours(23, 59, 59, 999));
  
  // Get today's sales
  const salesQuery = await db.collection('sales')
    .where('branchId', '==', currentBranch)
    .where('date', '>=', startOfDay)
    .where('date', '<=', endOfDay)
    .get();
  
  let todaySales = 0;
  salesQuery.forEach(doc => {
    todaySales += doc.data().total;
  });
  
  // Get today's expenses
  const expensesQuery = await db.collection('expenses')
    .where('branchId', '==', currentBranch)
    .where('date', '>=', startOfDay)
    .where('date', '<=', endOfDay)
    .get();
  
  let todayExpenses = 0;
  expensesQuery.forEach(doc => {
    todayExpenses += doc.data().amount;
  });
  
  // Get low stock products
  const productsQuery = await db.collection('products')
    .where('branchId', '==', currentBranch)
    .where('stock', '<=', firebase.firestore.FieldValue.arrayUnion(10))
    .limit(5)
    .get();
  
  let lowStock = [];
  productsQuery.forEach(doc => {
    lowStock.push(doc.data());
  });
  
  const html = `
    <div class="dashboard-grid">
      <div class="stat-card">
        <h3>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
        <div class="value">${todaySales.toFixed(2)}</div>
      </div>
      <div class="stat-card">
        <h3>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
        <div class="value">${todayExpenses.toFixed(2)}</div>
      </div>
      <div class="stat-card">
        <h3>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</h3>
        <div class="value">${(todaySales - todayExpenses).toFixed(2)}</div>
      </div>
      <div class="stat-card">
        <h3>Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</h3>
        <div class="value">${customers.length}</div>
      </div>
    </div>
    
    <div class="form-container">
      <h3>Ø£ØµÙ†Ø§Ù Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h3>
      ${lowStock.length > 0 ? lowStock.map(product => `
        <div class="alert alert-warning">
          ${product.name} - Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${product.stock}
        </div>
      `).join('') : '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ù…Ù†Ø®ÙØ¶Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</p>'}
    </div>
    
    <div class="form-container">
      <h3>Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h3>
      <div id="recentNotifications"></div>
    </div>
  `;
  
  document.getElementById('mainContent').innerHTML = html;
  await loadRecentNotifications();
}

// POS System
async function loadPOS() {
  await loadProducts();
  await loadCustomers();
  
  const html = `
    <div class="form-container">
      <div class="form-grid">
        <div>
          <h3>Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹</h3>
          <div class="form-group">
            <label>Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù</label>
            <input type="text" id="searchProduct" class="form-control" placeholder="Ø§Ø³Ù… Ø£Ùˆ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„ØµÙ†Ù" onkeyup="searchProduct()">
          </div>
          <div id="productGrid" class="mb-20"></div>
        </div>
        <div>
          <h3>ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¨ÙŠØ¹</h3>
          <div class="form-group">
            <label>Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
            <select id="posCustomer" class="form-control">
              <option value="">Ù†Ù‚Ø¯ÙŠ</option>
              ${customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
            </select>
          </div>
          <div class="form-group">
            <label>Ø§Ù„Ø®ØµÙ…</label>
            <input type="number" id="posDiscount" class="form-control" value="0">
          </div>
          <div id="cartItems" class="mb-20"></div>
          <div class="form-group">
            <h3>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="cartTotal">0.00</span></h3>
          </div>
          <button class="btn btn-success w-100 mb-10" onclick="completeSale()">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹</button>
          <button class="btn btn-danger w-100" onclick="clearCart()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>
  `;
  
  document.getElementById('mainContent').innerHTML = html;
  renderCart();
  renderProductGrid();
}

// Render Product Grid for POS
function renderProductGrid() {
  const container = document.getElementById('productGrid');
  container.innerHTML = products.map(product => `
    <div class="btn btn-outline" onclick="addToCart('${product.id}')" 
         style="margin: 5px; padding: 10px; text-align: center;">
      <div><strong>${product.name}</strong></div>
      <div>${product.price} Ø¬</div>
      <div>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${product.stock}</div>
    </div>
  `).join('');
}

// Add to Cart
function addToCart(productId) {
  const product = products.find(p => p.id === productId);
  if (!product) return;
  
  if (product.stock <= 0) {
    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø®Ø²ÙˆÙ† ÙƒØ§ÙÙŠ');
    return;
  }
  
  const existingItem = cart.find(item => item.id === productId);
  if (existingItem) {
    if (existingItem.quantity < product.stock) {
      existingItem.quantity++;
      existingItem.total = existingItem.quantity * product.price;
    }
  } else {
    cart.push({
      id: productId,
      name: product.name,
      price: product.price,
      quantity: 1,
      total: product.price
    });
  }
  
  renderCart();
}

// Render Cart
function renderCart() {
  const container = document.getElementById('cartItems');
  const totalElement = document.getElementById('cartTotal');
  
  let total = 0;
  container.innerHTML = cart.map(item => {
    total += item.total;
    return `
      <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;">
        <div>
          <strong>${item.name}</strong><br>
          ${item.price} Ã— ${item.quantity}
        </div>
        <div>
          ${item.total.toFixed(2)} Ø¬
          <button class="btn btn-danger btn-sm" onclick="removeFromCart('${item.id}')">âœ•</button>
        </div>
      </div>
    `;
  }).join('');
  
  totalElement.textContent = total.toFixed(2);
}

// Complete Sale
async function completeSale() {
  if (cart.length === 0) {
    alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©');
    return;
  }
  
  const customerId = document.getElementById('posCustomer').value;
  const discount = parseFloat(document.getElementById('posDiscount').value) || 0;
  
  const total = cart.reduce((sum, item) => sum + item.total, 0);
  const finalTotal = total - discount;
  
  try {
    // Create sale document
    const saleRef = await db.collection('sales').add({
      customerId: customerId || null,
      items: cart,
      subtotal: total,
      discount: discount,
      total: finalTotal,
      date: new Date(),
      uid: currentUser.uid,
      branchId: currentBranch,
      cashboxId: currentCashbox
    });
    
    // Update product stock
    for (const item of cart) {
      const productRef = db.collection('products').doc(item.id);
      const productDoc = await productRef.get();
      const currentStock = productDoc.data().stock;
      
      await productRef.update({
        stock: currentStock - item.quantity
      });
    }
    
    // Update cashbox balance
    if (currentCashbox) {
      const cashboxRef = db.collection('cashboxes').doc(currentCashbox);
      await cashboxRef.update({
        balance: firebase.firestore.FieldValue.increment(finalTotal)
      });
    }
    
    // Create transaction record
    await db.collection('transactions').add({
      type: 'income',
      amount: finalTotal,
      description: `Ø¨ÙŠØ¹ #${saleRef.id}`,
      date: new Date(),
      uid: currentUser.uid,
      branchId: currentBranch,
      cashboxId: currentCashbox
    });
    
    // Print invoice
    printInvoice(saleRef.id);
    
    // Clear cart
    cart = [];
    renderCart();
    
    alert('ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¨ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­');
  } catch (error) {
    alert('Ø­Ø¯Ø« Ø®Ø·Ø£: ' + error.message);
  }
}

// Print Invoice
function printInvoice(saleId) {
  const printWindow = window.open('', '_blank');
  printWindow.document.write(`
    <html>
      <head>
        <title>ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹ #${saleId}</title>
        <style>
          body { font-family: Arial; padding: 20px; }
          .invoice-header { text-align: center; margin-bottom: 30px; }
          .invoice-details { margin-bottom: 20px; }
          table { width: 100%; border-collapse: collapse; }
          th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
          .total { font-size: 18px; font-weight: bold; margin-top: 20px; }
        </style>
      </head>
      <body>
        <div class="invoice-header">
          <h1>ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹</h1>
          <p>Ø±Ù‚Ù… Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${saleId}</p>
          <p>Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-EG')}</p>
        </div>
        <div id="invoiceContent"></div>
      </body>
    </html>
  `);
  
  // Add invoice content
  const invoiceContent = cart.map(item => `
    <tr>
      <td>${item.name}</td>
      <td>${item.quantity}</td>
      <td>${item.price}</td>
      <td>${item.total}</td>
    </tr>
  `).join('');
  
  const total = cart.reduce((sum, item) => sum + item.total, 0);
  const discount = parseFloat(document.getElementById('posDiscount').value) || 0;
  const finalTotal = total - discount;
  
  printWindow.document.getElementById('invoiceContent').innerHTML = `
    <table>
      <thead>
        <tr>
          <th>Ø§Ù„ØµÙ†Ù</th>
          <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
          <th>Ø§Ù„Ø³Ø¹Ø±</th>
          <th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th>
        </tr>
      </thead>
      <tbody>
        ${invoiceContent}
      </tbody>
    </table>
    <div class="total">
      <p>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${total.toFixed(2)}</p>
      <p>Ø§Ù„Ø®ØµÙ…: ${discount.toFixed(2)}</p>
      <p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${finalTotal.toFixed(2)}</p>
    </div>
  `;
  
  printWindow.document.close();
  printWindow.print();
}

// Helper Functions
function showAlert(elementId, message, type) {
  const element = document.getElementById(elementId);
  element.textContent = message;
  element.className = `alert alert-${type}`;
  element.classList.remove('hidden');
  
  setTimeout(() => {
    element.classList.add('hidden');
  }, 5000);
}

function logout() {
  auth.signOut().then(() => {
    currentUser = null;
    currentBranch = null;
    window.location.reload();
  });
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  // Load branches for login
  db.collection('branches').get().then(snapshot => {
    const select = document.getElementById('loginBranch');
    snapshot.forEach(doc => {
      const option = document.createElement('option');
      option.value = doc.id;
      option.textContent = doc.data().name;
      select.appendChild(option);
    });
  });
});
</script>
</body>
</html>
